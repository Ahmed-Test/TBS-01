<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Tamkeen Billing System</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdn.payfort.com/merchant_page/css/fontello.css">
    <link rel="stylesheet" href="https://cdn.payfort.com/merchant_page/css/tooltip.css">

    <link rel="stylesheet" href="https://cdn.payfort.com/merchant_page/css/en/ccStyle-en.css">

    <!--Include arabic css if lang ar-->
    <link rel="stylesheet" th:href="@{'https://cdn.payfort.com/merchant_page/css/ar/ccStyle-' + ${currentLang} + '.css'}">

    <style>
        .half-containter{
            width: 50%;
            float: left;
        }

        .half-containter .popover{
            width:96%;
            margin:2%;
        }

        .half1{
            width: 100%;
        }

        .half2{
            width: 98%;
            margin-left:2%;
        }

        .card-container {
            max-width: 400px;
            height: 100%;
            border-radius: 5px;
            background: #fff;
            border: 1px solid #D3DAEB;
            padding: 2em;
            margin: 2em auto;
        }

        /***cards mada visa, master ******/
        .icon-stc-pay{
            background-size: contain;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAA0CAYAAAAddL/hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAGuaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyI+CiAgICAgICAgIDxkYzpjcmVhdG9yPgogICAgICAgICAgICA8cmRmOlNlcT4KICAgICAgICAgICAgICAgPHJkZjpsaT4xLjIuMC0yMEg8L3JkZjpsaT4KICAgICAgICAgICAgPC9yZGY6U2VxPgogICAgICAgICA8L2RjOmNyZWF0b3I+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgqIQZaXAAAMMUlEQVR4Xu2bCXBUVRaG/97SW/aNSAJEMCCyiqi4xKAgIEaoCMPoDCoMODI6otTEZQJCQAlupejglESUgTG4jEG0FCGSgCACEllCAiEsaiAkgexJ79ucc/s1WQkzdndMWflSr3jv3rfd/557zrn3NbJJ2gwXevjFyKV/e/iF9AjoJT0Cekm3E9DlcrXaujvdSkAWzGi2otrcJDbe7+4idisBDWYLFryXjP2uDLE9s3aKKOvOdLmATqcLNqsDdtpctN8WU5NV2gPMTTZp7xKQdTpsTtgsDjjsTjqWyruQLhOQG1hjakKTxYwrBoUhIj4IVZYmNJhMrYTUBWukPUIGVKAelaZ6NNJ5HsRQN1lQYW6AOiwAfYZHQKFXoNJcD5OJOqALh32XJNJ2thAl8Nq3D2Lk9X2lUjdffnAYS//wMcICdOJYGawUYpgarZjx5BjMfe52YVib1h/A6w99Dr1ajUpLPeYuHI/HXrhTXOOBbBovzfscn6zeg16aYGod9YCf8bsFOh1kLU4r8iyL2onH3H3/CGypTkOVtQkyuQz2BgfMZRYYa8yQWVxkhDJ6SRnUGiWc9FdpaUD20dR24jEKOi/t7al4ZeMDOG9u7JIh7XcBTVYr5mSMk46AnE8KMTnyRUwfsBKnis+LsvBwPe5/IhEWsw1GqxlV9gZUoUH4Sw/6EA0aYcKizGnoPzhKKgWqzjdia3Yhqi6QYBLjUoZg4r0jYKb7+Ru/C0iDF/HDo6Uj4L1F21FWXY0zp8/jkRGZ2Jx1CKl3ZyFvbQHsdO5f3pyEA66XcNy1EmG9A5EoS8ekkBVYkZKNIOgx7eHrpTsBby36Gkm90rFs+kdIjF6Cje/kSzXAHbOGwUZ39Dd+F1BBfz8VuC2N+bD4cazeMQ/zVkzE1bfG4smZ67BnczEcZoqiPGBb+C0evtwBTpMTFpMN4+8bKtUAdbUGvLV8C/pqIhGk1aGfOhIr//wFMpfmIVG5FIunfEDlWuls/+F3AbXqAGSmbYPF3mwNY5IGYPazSViVOxslrtcx7OZ4mGmoM21TG/Z/CqWcvJ8LcQkRUimwd/NJhIECD+nNkrP/1NGzNqTvhE6uRIhW7z7Rz/hdQDk1LESlwS2qxchMz0NdnVGqaebt3XMQ0S9YDOFWtNCSReJ8z4M2KECI2hLOXsx0F4vNBifnhV2A3wVkGmwmapYTGzK+RVJYOm6VLcETE9ehrLRWOgOYlZ5EjSen3yLzsNubBZPTX9GeM9IRkDRlMAywihSJdeTEvMZqwMazqUh+bDScAZQBdIGIfhewxmTAmiOP4pDrReywLiYbc9GfE9tzCrHioU3SWRRlg9Wihoesh6FJfVFOiXS5qRbBMTrs3nVcqnHz6bFUONRAqbkaFqcDWUceR+/YUKSuSsb6kr+KjvM3fhdQRY8oP9lsafmmDMxZNg4LlifjzbxZUimw89NiaBGA04XNAWfoqDiccr1B4r+Mv62/R9zrcbJcDwOujkaecRGKXK9ip3MJBg6NkWqAJxL/Bb28xazGT/hdwEC1BmkpWag4Wy+ONRoV/vTcWMxOS4JcirgHd/+ML97PR4hah88yvxdlbbGaHVCThPk5J7D0wWyptGOenroB505XQ6VWSCX+Q3GValy6tO8XOC3RyCkSv5qL2nIDzYGDERqlg4Oi7bGCcqxK3YpXF3yOaJp6cSQNoLTn3WU7EDs0AlcMCINcIUNJUQXefWY7Gs8aoddqUPxDGT5+Yx8Ce2kR0TcYOp0KNRSc8rKLMH/sOvx4uAKBXZDCMF32UYkXAHhmYCbHb5GirQZK2lTCKlvOW3nhwWiz0LzDSt7SfZ5eRvZH0zkPvApjtFtE4KFMkWSXi3vplNQFKv9bnoeer3Je0iVpzG+ZHgG9RHYD0nqGsBfIjpdUdirgwITmlZQe2iOj6NhjgV7gNwGPN5SjzFgNpUyBq4Ji0FsXJtX8tvBKwI9+3I23judAr1SjytyI/ckrkP3zPqwu+ZqikwxKuTsfszhsCFRp8eTgyUiKuUaUdcRtW5ZAp1Bf8lMGrw9yR9zZezh+H3+zVOrm6R/eR37VaagVSrGosG/ycqmmNXsunMBT+f9GkEqDeqsRr4x+ELdED5Rq/3+8isJqhQohKp3Y+ugjsPjQx1hzIhfhAYEIC9AjUKmhF9UikmYZKhLz+YJsLC/YKF3dnmC+V4D7fh1twXQvbvS6k99g9u5/Sle5eWhAkngGnxelDsL2iiKppjV55UcQRe/D9wqhd/RGPMbrNIathadrLObRujMIUmrFKgh/JKrnfy2NwgIVMrl48Z2Vx7CBLLcjGmxGuubSm8lhFVbNIleY6rCl7JB0JTAktA809A68oqOWq7C17LBU05pdlcVUr4TVacfE2BFS6S/HqyG8qfR7vHdyOw1h96oHC6VVBGDh8HtxTWicKDNTo187+qV48VBqOD+uwlyHvAlLLi4meCiqO0s+s+M+VVGjD1SfxrpT35A70IhnjQy/EotHTJPOAN4pycWXZw8IIS+YG5A7cbFU44bvn5q/nt5DjxpLE1aNmYME8s/e4LNE2u50CCGzbpt/UTxGQ4KmDUvBWPJ9Zmo0WysP1fdP75LOaGYIXTcopHeHW/+gaEyPHwMFWaCTOoH9odXZ+qvbvf1uQJPdLJ6hpTkxW3tLcmn4srhOl1PUeyse4zMBG21mcsgzpaP2PDN0Kp1jEhYYQNa090KJVNM5DmrsGUM1vjtfQtZ1ECqy0EvEGESQ74vTRYjO5GGcc671MM4tLxTPtjjsmBx7rVTqHT61wHB1oHTUMfGBUUIQHqY/N1VJpa1hv7bwwId4YNc/MGlbBiZ8/QIe/m41Mo5spOieI3xpyy93bUnpe70Y3hxQOOJ6KKVOMDks5DbkMDjMmBJ3nVTjHT4TkM2Ch1ZnRKpDhJNnrK7232xnfLMSbx77CsX1ZbCQkw+hSBlGEZ2HGzfcQfe/nMOeSgI22d2/6NKQFbLlMtvKC0SKxB0YqQ5GjI/yUt8JSC3rzDKYJrtR+C6GLaklC/avg5UshyOsQi5HrcUgImWcLpxSjUGYOSARL1/HLsJ12Y4aHdEfNhcNY8oJPcN427kjCKBjts7kuFGizBf4TED+fMnOuTNKGiqEcGwFV2hDpVKO1DYcrPlJWJpniG+8PRWf3v4UVt4wC6lD7sGMfjeJIMMfpS5HCgUTk90q/N2+qhNwkHvhqMzPbiJffU+f0dKZ3uMzATn/Sz/0iXTUnk2l+0X+xVZqowaxlXg4TkNWR9Ga4YY/MmiCmCl0hIGGZ+d2DtwUNVB0BMOZQSrNUjiFYj/NfpiTaF/hMwF5eBTVlWLxwY+kkmZ2VhyjKd8WMeVjOCn+XfxNYp9hS/F4NxaYh29HPLInE3oS+nKugplA0z32oxxMzlIA4QTcQmlPso+ChwefJtI8hNm6OKUZFtZHTOOOUvLKVsO9zg3n/VFkfekjpotrPIzduhQxmhCx32g3YW7COIwK7y/84MGaH0XeyAkM53F8HyulIoNDY/HCtfeJa9pysrESj+5dQ6mNlBlQK/kHmNsmLBIByVf47E4OpxM6sjDuDX5pThsKa8+I2QYHBjYaAyW5PDTbisfM7J+IWqtBnMfuYO3JHZi3NxPzv1+LLEm8SE2QmDL+L31+VVAv8SzPUOagMiQszqfiMT67Wx01fu0tj6J/YDTOk8O2keXwb1fYggxkkeXGetwYmYCsxPnSFa2Zm3AH7qLk9pyxDkaa/rHD51lMAA09nl3EUNBZc/M8nDPVopqmYTU01+bEvDOm9b1RRF3GHX19O3wZnw1hjnKbx/9d+DNOkndUFomfZPB6YDyJelfsyIs+sDN4teUrSqZLDVXCL/Ly1a1RV+NKmsox54y1wqq5jufHkTT7uBT7q05h6eH/iFUh7tS8NnNjX+BTAb8Y96zwUd2Fp3/IwqnGCuH/EoJj8OJ1f5RqfIdvHcKvDM9xOVVheCGhgHJLFY0AXgbzZe7Xkt+MgOyDx2xOE/Pn8TnP4+XCz8Q0kIcXz1x4NuMPvBLQnY1dPifrCjjo8IKtZ+MUin/ywQuvC4enSGf5Hq8E5N+msO9zb40XU4ZfA35287s0COE4J102cgYSew2WzvI9XgURfkFOU3iBgP8PB0e7XxNeheF8kRukpWDWdsXbH3glYA/AfwFgAkMSsKl0OAAAAABJRU5ErkJggg==");
            background-repeat: no-repeat;
            width: 90px !important;
            height: 24px !important;
            margin-left: 5px;
            margin-right: 5px;
            display: inline-block;
        }

        .pay { background-color: #ba0c2f !important;}

        .pay span { display: inline !important; }

        .display-block { display: block !important; }

        .hide-block { display: none; !important; }

        .align-right{ text-align: right !important; }

        .align-center {text-align: center !important; }

        .direction-right { direction: rtl; }



    </style>


    <script th:inline="javascript">
        /*<![CDATA[*/
        var mobileValidationStatus = /*[[${mobileValidationStatus}]]*/ "";
        console.log('--- mobileValidationStatus:' + mobileValidationStatus);
        var transactionIdBilling = /*[[${transactionId}]]*/ "";
        console.log('--- transactionIdBilling:' + transactionIdBilling);
        var payButtonLabel = /*[[${payButtonLabel}]]*/ "";
        console.log('--- payButtonLabel:' + payButtonLabel);
        var actionUrl = /*[[${actionUrl}]]*/ "";
        console.log('--- actionUrl:' + actionUrl);
        /*]]>*/

        if (mobileValidationStatus == 'INVALID') {
            document.getElementById("error_mobile").classList.add("display-block");
        }

    </script>

    <script>
        function payOnClick() {
            // check if mobile submit
            if (mobileValidationStatus != 'VALID') {
                var mobileNo= document.getElementById('mobile_no').value;
                console.log('mobileNo ' + mobileNo.length);
                if (mobileNo.length == 10 && mobileNo.toString().startsWith('05')) {
                    validateMobile(mobileNo, transactionIdBilling).then(function(response) {
                        console.log('--- validateMobile resp: ' + JSON.stringify(response));
                        // console.log('--- validateMobile resp: ' + (response));
                        // if (response != null) {
                            // window.top.location.href = response;
                            // success case
                            document.getElementById("error_mobile").classList.remove("display-block");
                            mobileValidationStatus = 'VALID';
                            // mobile_row  -- otp_row  hide-block
                            document.getElementById('mobile_row').classList.add("hide-block");
                            document.getElementById('otp_row').classList.remove("hide-block");
                            // change submit label
                            document.getElementById("submitButtonText").innerHTML = payButtonLabel;
                            document.getElementById("mobile_no").focus();
                        // }
                    }).catch(err => {
                        console.log('--- validateMobile resp err: ' + JSON.stringify(err));
                        document.getElementById("error_mobile").classList.add("display-block");

                    });
                } else {
                    document.getElementById("error_mobile").classList.add("display-block");
                }
                return false;
            } else {
                var optValue = document.getElementById('opt_value').value;
                console.log('opt_value ' + optValue.length);
                if (optValue.length < 4 ) {
                    console.log('validation failed');
                    document.getElementById("error_msg").classList.add("display-block");
                    return false;
                }
                document.getElementById("error_msg").classList.remove("display-block");
                console.log('validation pass');
                startLoading();
                document.redirectForm.submit();
            }
        }

        function isNumber(evt) {
            var code = evt.keyCode || evt.which;
            var regex = new RegExp("^\\d+$");
            if(evt.key.match(regex) || code == '9' || code == '8'){
                return true;
            }
            return false;
        }

        window.onload = function() {
            console.log('---load iframe');
            if (mobileValidationStatus == 'VALID') {
                document.getElementById("opt_value").focus();
            } else {
                document.getElementById("mobile_no").focus();
            }
        }

        /*Validate mobile*/
        /**
         * Server to Server call to complete the payment
         */
        function validateMobile(mobile, transactionId) {
            return new Promise(function (resolve, reject) {
                var xhr = new XMLHttpRequest();
                console.log('--- authorize sending post req to backend');
                // !!! ----------------------------- Ahmed must change To mule
                xhr.open('POST', '/billing/payments/stcpay-payment-processing');
                // xhr.open('POST', actionUrl);
                // add header test
                // xhr.setRequestHeader("Access-Control-Allow-Origin", "*");
                xhr.onload = function () {
                    if (this.status >= 200 && this.status < 300) {
                        console.log('--- Success result');
                        resolve(xhr.response);
                    } else {
                        console.log('--- Fail result');
                        reject({
                            status: this.status,
                            statusText: xhr.statusText
                        });
                    }
                };
                xhr.onerror = function () {
                    reject({
                        status: this.status,
                        statusText: xhr.statusText
                    });
                };
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.send(JSON.stringify({merchant_reference: transactionId, mobile_no: mobile}));
            });
        }

    </script>
</head>
<body>



<div id="CreditCardDiv">
    <div class="row">
        <h4 id="page-heading" th:classappend="(${currentLang}== 'ar')? 'align-right direction-right' : ''">
                <span class="payment-title"><span th:text="${formTitle}" style="cursor: default;"> STC Pay  </span>
                    <i class="icon-stc-pay"></i>
                </span>
        </h4>
    </div>

    <form  th:action="${actionUrl}" method="post" name="redirectForm" target="_top">
        <input type="hidden" name="merchant_reference" th:value="${transactionId}">

        <div class="row">
            <div class="card-container">

                    <span class="popover" id="error_msg" th:classappend="(${currentLang}== 'ar')? align-right : ''">
                        <span class="content" th:text="${codeInvalid}"></span>
                    </span>

                    <span class="popover" id="error_mobile" th:classappend="(${currentLang}== 'ar')? align-right : ''">
                        <span class="content" th:text="${mobileInvalid}"></span>
                    </span>

                <span class="input" id="mobile_row" th:classappend="(${mobileValidationStatus} == 'VALID')? hide-block : ''">
                                    <input class="input-field align-center" type="tel" name="mobile_no" id="mobile_no" pattern="[0-9]*" maxlength="10"
                                           onkeypress="javascript: return isNumber(event)" th:value="${MobileNo}"
                                           ondrag="return false" ondrop="return false" autocomplete="off" autofocus>
                                    <label class="input-label" for="">
                                        <i class="fas fa-shield-alt"></i>
                                        <span class="input-label-content"  th:text="${mobileLabel}">Mobile number</span>
                                    </label>
                                </span>

                <span class="input" id="otp_row" th:classappend="(${mobileValidationStatus} != 'VALID')? hide-block : ''">
                                    <input class="input-field align-center" type="tel" name="opt_value" id="opt_value" pattern="[0-9]*" maxlength="8"
                                           onkeypress="javascript: return isNumber(event)"
                                           ondrag="return false" ondrop="return false" autocomplete="off" autofocus>
                                    <label class="input-label" for="">
                                        <i class="fas fa-shield-alt"></i>
                                        <span class="input-label-content"  th:text="${optLabel}">Verification Code</span>
                                    </label>
                                </span>


                <button type="submit" id="submitBtn" class="pay br " data-text="Pay" onclick="javascript: return payOnClick();">
                    <i class="animated icon-spin4 animate-spin" id="loadingI" style="visibility: hidden;"></i>
                    <span id="submitButtonText" th:text="${submitButtonLabel}">Pay</span>
                </button>
            </div>
        </div>
    </form>
</div>
</body>


</html>
